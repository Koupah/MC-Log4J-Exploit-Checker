package club.koupah.logchecker.utils;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.regex.Matcher;
import java.util.zip.GZIPInputStream;

import club.koupah.logchecker.Checker;
import club.koupah.logchecker.ExploitChecker;

public class Utils {

	static File tempFolder;
	static {
		tempFolder = new File("ExploitChecker-Temp");
		tempFolder.mkdir();
		tempFolder.deleteOnExit();
	}

	private static boolean windows = System.getProperty("os.name").toLowerCase(Locale.ENGLISH).startsWith("windows");

	public static boolean isWindows() {
		return windows;
	}

	public static boolean getBooleanInput() {
		String input = getInput("y", "yes", "n", "no", "true", "false");
		return input.equalsIgnoreCase("y") || input.equalsIgnoreCase("yes") || input.equalsIgnoreCase("true");
	}

	public static File getDirectoryInput() {
		String input;

		while ((input = getInput()) != null) {
			File in;
			try {
				in = new File(input);

				if (!in.exists()) {
					log("Error: That directory doesn't exist!");
				} else if (!in.isDirectory()) {
					log("Error: That is a File, not a Directory");
				} else {
					return in;
				}
			} catch (Exception e) {
				log("Error: Invalid File! (" + e.getMessage() + ")");
			}
		}

		return null;
	}

	// Wrote this with no sleep, really should've just done like new File(dir,
	// folderName).exists() lmao
	public static boolean containsFolder(File dir, String folderName) {
		for (File file : dir.listFiles())
			if (file.isDirectory() && file.getName().equalsIgnoreCase(folderName))
				return true;

		return false;
	}

	public static void waitForEnter() {
		Checker.input.nextLine();
	}

	public static String getInput(String... validInput) {
		String input;
		final String valid = String.join(", ", validInput);

		while ((input = getInput()) != null) {
			if (!contains(input, validInput)) {
				log("Invalid Input! (Accepted: " + valid + ")");
			} else {
				break;
			}
		}

		return input;
	}

	public static String getInput() {
		logSameLine(" > ");
		return Checker.input.nextLine();
	}

	private static boolean contains(String checking, String[] array) {
		if (array.length == 0)
			return true;

		for (String string : array)
			if (checking.equalsIgnoreCase(string))
				return true;

		return false;
	}

	public static String logSameLine(Object out) {
		System.out.print(out);
		return out.toString();
	}

	public static String log(Object out) {
		System.out.println(out);
		return out.toString();
	}

	public static List<File> checkAllFiles(File directory) {
		List<File> containing = new ArrayList<File>();

		for (File file : directory.listFiles()) {
			if (file.isFile()) {
				final String name = file.getName();

				if (name.endsWith(".log")) {
					if (checkIfContains(file))
						containing.add(file);
				} else if (name.endsWith(".log.gz")) {
					if (checkGZIP(file))
						containing.add(file);
				} else {
					System.out.println("Found unsupported file \"" + name + "\" in logs folder, skipping it!");
				}
			}
		}

		return containing;
	}

	public static boolean checkGZIP(File file) {
		boolean found = false;
		try {
			InputStream in = new GZIPInputStream(new FileInputStream(file));

			File tempTxt = new File(tempFolder, file.getName() + ".temp");

			OutputStream out = new FileOutputStream(tempTxt);

			byte[] buffer = new byte[65536];
			int noRead;
			while ((noRead = in.read(buffer)) != -1) {
				out.write(buffer, 0, noRead);
			}
			out.close();
			in.close();

			found = checkIfContains(tempTxt);

			if (found) {
				System.out.println(
						"The above .temp exploit logs were from a compressed log: \"" + file.getAbsolutePath() + "\".");
			}

			tempTxt.delete();

		} catch (Exception e) {
			System.out.println("Couldn't check GZipped log \"" + file.getName() + "\" (" + e.getMessage() + ")");
		}

		return found;
	}

	public static boolean checkIfContains(File log) {
		boolean found = false;

		try {
			BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(log)));

			String line;
			int lineCount = 0;
			while ((line = reader.readLine()) != null) {
				lineCount++;
				if (ExploitChecker.hasLog4jFormat(line)) {
					found = true;
					Matcher results = ExploitChecker.getLog4jMatcher(line);
					System.out
							.println("Potential exploit usage on line " + lineCount + " of " + log.getAbsolutePath() + ": ");

					results.reset();
					while (results.find()) {
						System.out.println(" - Found: " + results.group());
					}
				}
			}

			reader.close();
		} catch (Exception e) {
			e.printStackTrace();
			System.out.println("Couldn't read file \"" + log.getName() + "\" (" + e.getMessage() + ")");
		}

		return found;
	}

	public static int getNumberInput(int min, int max) {
		String input;
		while ((input = getInput()) != null) {
			try {
				int number = Integer.parseInt(input);
				if (number < min) {
					System.out.println("Your input (" + number + ") is smaller than the minimum (" + min + ").");
				} else if (number > max) {
					System.out.println("Your input (" + number + ") is larger than the maximum (" + max + ").");
				} else {
					return number;
				}
			} catch (Exception e) {
				System.out.println("Invalid Number! Please input an integer between " + min + " and " + max + ".");
			}
		}

		return 0;
	}

}